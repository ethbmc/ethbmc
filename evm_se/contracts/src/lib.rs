extern crate esvm;
extern crate num_cpus;
extern crate yaml_rust;

#[macro_use]
extern crate lazy_static;

use std::sync::Arc;

use esvm::{symbolic_analysis, SeEnviroment, SolverPool, Solvers, CONFIG};
use yaml_rust::YamlLoader;

lazy_static! {
    static ref SOLVER_POOL: Arc<SolverPool> = {
        esvm::create_pool(Solvers::Yice {
            count: num_cpus::get(),
            timeout: SOLVER_TIMEOUT,
        })
    };
}

static SOLVER_TIMEOUT: usize = 120_000;

pub fn run_analysis(s: &str) -> Option<String> {
    let yaml = &YamlLoader::load_from_str(s).unwrap()[0];
    {
        let mut config = CONFIG.write().unwrap();

        // test config
        config.loop_bound = 1;
        config.call_depth_limit = 2;
        config.message_bound = 2;
        config.arithmetic_simplification = true;
        config.concrete_load = true;
        config.concrete_copy = true;
    }

    let c = CONFIG.read().unwrap().clone();
    let res = symbolic_analysis(
        SeEnviroment::from_yaml(yaml),
        c,
        Solvers::Initialized(Arc::clone(&SOLVER_POOL)),
    );
    return Some(format!("{}", res));
}

#[macro_export]
macro_rules! build_bench_tests {
    () => {
        suicide!(bench_test);
        function_call!(bench_test);
        function_call_args!(bench_test);
        proxy!(bench_test);
        delegate_call!(bench_test);
        control_flow_hijack!(bench_test);
        rubixi!(integration_test);
        parity_reduced!(integration_test);
    };
}

#[macro_export]
macro_rules! build_integration_tests {
    () => {
        suicide!(integration_test);
        function_call!(integration_test);
        function_call_args!(integration_test);
        proxy!(integration_test);
        delegate_call!(integration_test);
        control_flow_hijack!(integration_test);
        rubixi!(integration_test);
        parity_reduced!(integration_test);
    };
}

#[macro_export]
macro_rules! suicide {
    ($callback:ident) => {
        $callback!(
            unprotected_function_suicide,
            UNPROTECTED_FUNCTION_SUICIDE,
            "can transfer funds to attacker controlled account",
            "0x2f432c08",
            "0x41c0e1b5"
        );
    };
}

#[macro_export]
macro_rules! function_call {
    ($callback:ident) => {
        $callback!(
            unprotected_function_call,
            UNPROTECTED_FUNCTION_CALL,
            "can transfer funds to attacker controlled account",
            "0x2f432c08",
            "0xb46300ec"
        );
    };
}

#[macro_export]
macro_rules! function_call_args {
    ($callback:ident) => {
        $callback!(
            unprotected_function_call_args,
            UNPROTECTED_FUNCTION_CALL_ARGS,
            "can transfer funds to attacker controlled account",
            "0x2f432c08",
            "0x3e58c58c",
            "dfa72de72f96cf5b127b070e90d68ec",
            "0x9710797c"
        );
    };
}

#[macro_export]
macro_rules! proxy {
    ($callback:ident) => {
        $callback!(
            proxy_call,
            PROXY_CALL,
            "can transfer funds to attacker controlled account",
            "0xe9ca826c",
            "0x7c52e325",
            "dfa72de72f96cf5b127b070e90d68ec",
            "0x9710797c"
        );
    };
}

#[macro_export]
macro_rules! delegate_call {
    ($callback:ident) => {
        $callback!(
            delegate_call,
            DELEGATECALL,
            "can transfer funds to attacker controlled account",
            "0x3e326048",
            "0x3e58c58c",
            "dfa72de72f96cf5b127b070e90d68ec",
            "0x9710797c"
        );
    };
}

#[macro_export]
macro_rules! control_flow_hijack {
    ($callback:ident) => {
        $callback!(
            control_flow_hijack,
            HIJACK,
            "can hijack control flow to attacker controlled contract",
            "0x3d9ba18a",
            "f9c3105115695a35c25588d4e768c6c2",
            "0xe573338d"
        );
    };
}

#[macro_export]
macro_rules! rubixi {
    ($callback:ident) => {
        $callback!(
            rubixi,
            RUBIXI,
            "can transfer funds to attacker controlled account",
            "0x67f809",
            "0x422961",
            "0x686f2c",
            "0xb40229"
        );
    };
}

#[macro_export]
macro_rules! parity_reduced {
    ($callback:ident) => {
        $callback!(
            parity_reduced,
            PARITY_REDUCED,
            "can transfer funds to attacker controlled account",
            "0xc57c5f6",
            "0dfa72de72f96cf5b127b070e90d68ec",
            "9710797c"
        );
    };
}

#[macro_export]
macro_rules! bench_test {
    ($test_name:ident, $var_name:ident, $($containt:tt),+) => {
        #[bench]
        fn $test_name(b: &mut Bencher) {
            b.iter( || {
                build_inner!($var_name, $($containt,)+);
            })
        }
    };
}

#[macro_export]
macro_rules! integration_test {
    ($test_name:ident, $var_name:ident, $($containt:tt),+) => {
        #[test]
        #[ignore]
        fn $test_name() {
            build_inner!($var_name, $($containt,)+);
        }
    };
}

#[macro_export]
macro_rules! build_inner_expensive {
    ($var_name:ident, $($containt:expr,)+) => {
        let res = run_expensive_analysis($var_name);
        assert!(res.is_some());
        let s = res.unwrap();
        $(assert!(s.contains($containt));)+
    }
}

#[macro_export]
macro_rules! build_inner {
    ($var_name:ident, $($containt:expr,)+) => {
        let res = run_analysis($var_name);
        assert!(res.is_some());
        let s = res.unwrap();
        $(assert!(s.contains($containt));)+
    }
}

pub const UNPROTECTED_FUNCTION_SUICIDE: &str = "
state:
    0xaad62f08b3b9f0ecc7251befbeff80c9bb488fe9:
        balance: 0x100000
        nonce: 0x1000000
        code: 60606040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632f432c081461005157806341c0e1b514610066575b600080fd5b341561005c57600080fd5b61006461007b565b005b341561007157600080fd5b6100796100bd565b005b336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561011557fe5b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16ff00a165627a7a72305820f3144583596e67d998d568c2e75c63dd961472f8f27d9fb5bad677c80d5d3dd30029
        storage:
            0x0: 0xaad62f08b3b9f0ecc7251befbeff80c9bb488fe9


victim: 0xaad62f08b3b9f0ecc7251befbeff80c9bb488fe9
";

pub const UNPROTECTED_FUNCTION_CALL: &str = "
state:
    0xaad62f08b3b9f0ecc7251befbeff80c9bb488fe9:
        balance: 0x100000
        nonce: 0x1000000
        code: 60606040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632f432c0814610051578063b46300ec14610066575b600080fd5b341561005c57600080fd5b61006461007b565b005b341561007157600080fd5b6100796100bd565b005b336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561011557fe5b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc3073ffffffffffffffffffffffffffffffffffffffff16319081150290604051600060405180830381858888f19350505050505600a165627a7a72305820d75c6761a4d0d06e3c46331d51fdfbba10399d6e07f1db08a7d76d01bce893b60029
        storage:
            0x0: 0xaad62f08b3b9f0ecc7251befbeff80c9bb488fe9


victim: 0xaad62f08b3b9f0ecc7251befbeff80c9bb488fe9
";

pub const UNPROTECTED_FUNCTION_CALL_ARGS: &str = "
state:
    0xaad62f08b3b9f0ecc7251befbeff80c9bb488fe9:
        balance: 0x100000
        nonce: 0x1000000
        code: 60606040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632f432c08146100515780633e58c58c14610066575b600080fd5b341561005c57600080fd5b61006461009f565b005b341561007157600080fd5b61009d600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506100e1565b005b336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561013957fe5b8073ffffffffffffffffffffffffffffffffffffffff166108fc3073ffffffffffffffffffffffffffffffffffffffff16319081150290604051600060405180830381858888f1935050505050505600a165627a7a7230582036758e41dfbec0634f82e1211f57a0c08942a965fd8b7afa606e21b2fd109c3b0029
        storage:
            0x0: 0xaad62f08b3b9f0ecc7251befbeff80c9bb488fe9


victim: 0xaad62f08b3b9f0ecc7251befbeff80c9bb488fe9
";

pub const PROXY_CALL: &str = "
state: 
    # Proxy
    0xad62f08b3b9f0ecc7251befbeff80c9bb488fe9:
        balance: 0x0
        code: 60806040526004361061004b5763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416637c52e3258114610050578063e9ca826c14610080575b600080fd5b34801561005c57600080fd5b5061007e73ffffffffffffffffffffffffffffffffffffffff60043516610095565b005b34801561008c57600080fd5b5061007e610145565b60005473ffffffffffffffffffffffffffffffffffffffff1633146100b657fe5b600154604080517f338ccd7800000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff84811660048301529151919092169163338ccd7891602480830192600092919082900301818387803b15801561012a57600080fd5b505af115801561013e573d6000803e3d6000fd5b5050505050565b6000805473ffffffffffffffffffffffffffffffffffffffff1916331790555600a165627a7a72305820b376cbf41ad45cba2c20890893f93f24efe850bf7eaf35fd12a0474576b4ac2d0029
        storage:
            0x0: 0x1 
            0x1: 0x86C249452EE469D839942E05B8492DBB9F9C70AC 

    # Receiver
    0x86c249452ee469d839942e05b8492dbb9f9c70ac:
        balance: 0x10000
        code: 606060405260043610603e5763ffffffff7c0100000000000000000000000000000000000000000000000000000000600035041663338ccd7881146043575b600080fd5b3415604d57600080fd5b606c73ffffffffffffffffffffffffffffffffffffffff60043516606e565b005b6000543373ffffffffffffffffffffffffffffffffffffffff908116911614609257fe5b8073ffffffffffffffffffffffffffffffffffffffff166108fc3073ffffffffffffffffffffffffffffffffffffffff16319081150290604051600060405180830381858888f19350505050151560e857600080fd5b505600a165627a7a72305820d94e263975863b2024dc4bfaba0287941709bc576381ae567f9683d8fc2052940029
        storage:
            0x0: 0x0AD62F08B3B9F0ECC7251BEFBEFF80C9BB488FE9 

victim: 0xad62f08b3b9f0ecc7251befbeff80c9bb488fe9
";

pub const DELEGATECALL: &str = "
state: 
    # Wallet
    0xad62f08b3b9f0ecc7251befbeff80c9bb488fe9:
        balance: 0x10000
        code: 608060405260003411156010576069565b600036111560695773cafecafecafecafecafecafecafecafecafecafe73ffffffffffffffffffffffffffffffffffffffff1660003660405180838380828437820191505092505050600060405180830381855af45050505b0000a165627a7a72305820e1a16a51052f67a80336a8bf3e6b1f49a89b6bd7245108b64906748949b503750029
        storage:
            0x0: 0xcafecafecafecafecafecafecafecafecafecafe # lib addr
            0x1: 0xad62f08b3b9f0ecc7251befbeff80c9bb488fe9 

    # WalletLibrary
    0xcafecafecafecafecafecafecafecafecafecafe:
        balance: 0x0
        code: 60806040526004361061004b5763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416633e32604881146100505780633e58c58c14610067575b600080fd5b34801561005c57600080fd5b50610065610095565b005b34801561007357600080fd5b5061006573ffffffffffffffffffffffffffffffffffffffff600435166100b6565b6000805473ffffffffffffffffffffffffffffffffffffffff191633179055565b60005473ffffffffffffffffffffffffffffffffffffffff1633141561011b5760405173ffffffffffffffffffffffffffffffffffffffff821690303180156108fc02916000818181858888f19350505050158015610119573d6000803e3d6000fd5b505b505600a165627a7a723058208a4d6aa89fe4136178249e6f866cdf5e87ee3846c904c4e7c388b036958a97a00029
        storage:
            0x0: 0xcafecafecafecafecafecafecafecafecafecafe # lib address

victim: 0xad62f08b3b9f0ecc7251befbeff80c9bb488fe9
";

pub const HIJACK: &str = "
state:
    0xaad62f08b3b9f0ecc7251befbeff80c9bb488fe9:
        balance: 0x0
        nonce: 0x1000000
        code: 608060405260043610603e5763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416633d9ba18a81146043575b600080fd5b348015604e57600080fd5b50606e73ffffffffffffffffffffffffffffffffffffffff600435166070565b005b8073ffffffffffffffffffffffffffffffffffffffff1660003660405180838380828437820191505092505050600060405180830381855af4505050505600a165627a7a723058204a53cc45907b47b1b978b63fd913f36c1da3477d58d2f60ea4209d68560c69710029

victim: 0xaad62f08b3b9f0ecc7251befbeff80c9bb488fe9
";

pub const RUBIXI: &str = "
state:
    0x692a70d2e424a56d2c6c27aa97d1a86395877b3a:
        balance: 0x000000000000000000000000000000000000000000000005e1bd6f2471e20000
        nonce: 0x1000000
        code: 6080604052600436106100da5763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166309dfdc7181146100e4578063253459e3146101785780634229616d1461019f57806357d4021b146101b757806367f809e9146101cc578063686f2c90146101e15780636fbaaa1e146101f65780638a5fb3ca1461020b5780639dbc4f9b14610220578063a26dbf261461025b578063a6f9dae114610270578063b402295014610291578063ced92670146102a9578063d11f13df146102c1578063fae14192146102d6575b6100e26102ee565b005b3480156100f057600080fd5b506100f9610332565b6040518083815260200180602001828103825283818151815260200191508051906020019080838360005b8381101561013c578181015183820152602001610124565b50505050905090810190601f1680156101695780820380516001836020036101000a031916815260200191505b50935050505060405180910390f35b34801561018457600080fd5b5061018d610367565b60408051918252519081900360200190f35b3480156101ab57600080fd5b506100e260043561037e565b3480156101c357600080fd5b5061018d6103f0565b3480156101d857600080fd5b506100e2610427565b3480156101ed57600080fd5b506100e2610448565b34801561020257600080fd5b506100f961049c565b34801561021757600080fd5b506100f96104c3565b34801561022c57600080fd5b506102386004356104e8565b60408051600160a060020a03909316835260208301919091528051918290030190f35b34801561026757600080fd5b5061018d61055e565b34801561027c57600080fd5b506100e2600160a060020a0360043516610564565b34801561029d57600080fd5b506100e26004356105a4565b3480156102b557600080fd5b506100e2600435610619565b3480156102cd57600080fd5b5061018d61064b565b3480156102e257600080fd5b506100e2600435610655565b6000670de0b6b3a764000034101561030d57600180543401905561032f565b506002546802b5e3af16b1880000341061032657600290045b61032f8161067b565b50565b60008054606090670de0b6b3a7640000900491506101006040519081016040528060ca815260200161089960ca913990509091565b600154600090670de0b6b3a7640000905b04905090565b600554600090600160a060020a03163314156103ec5760015415806103a35750606482115b156103ad57600080fd5b506001546005546040516064909204830291600160a060020a03909116906108fc8315029083906000818181858888f150506001805485900390555050505b5050565b6000670de0b6b3a7640000600660045481548110151561040c57fe5b90600052602060002090600202016001015481151561037857fe5b6005805473ffffffffffffffffffffffffffffffffffffffff191633179055565b600554600160a060020a031633141561049a57600154151561046957600080fd5b600554600154604051600160a060020a039092169181156108fc0291906000818181858888f1505060006001555050505b565b60035460408051610140810190915261011f80825260609190610963602083013990509091565b6002546040805160c08101909152608480825260609190610815602083013990509091565b6006546000908190831161055957600680548490811061050457fe5b600091825260209091206002909102015460068054600160a060020a039092169350670de0b6b3a7640000918590811061053a57fe5b90600052602060002090600202016001015481151561055557fe5b0490505b915091565b60065490565b600554600160a060020a031633141561032f5760058054600160a060020a03831673ffffffffffffffffffffffffffffffffffffffff1990911617905550565b600554600160a060020a031633141561032f57670de0b6b3a7640000810290506001548111156105d6576105d6610448565b60015415156105e457600080fd5b600554604051600160a060020a039091169082156108fc029083906000818181858888f1505060018054859003905550505050565b600554600160a060020a031633141561032f5761012c81118061063c5750607881105b1561064657600080fd5b600355565b6004546006540390565b600554600160a060020a031633141561032f57600a81111561067657600080fd5b600255565b60006006604080519081016040528033600160a060020a03168152602001606460035434028115156106a957fe5b04905281546001808201845560009384526020938490208351600290930201805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a039093169290921782559190920151910155600654600a141561070f5760c8600355610720565b600654601914156107205760966003555b60008054606434858203810282900490920190925560018054918502929092040190555b600660045481548110151561075557fe5b90600052602060002090600202016001015460005411156103ec57600660045481548110151561078157fe5b906000526020600020906002020160010154905060066004548154811015156107a657fe5b60009182526020822060029091020154604051600160a060020a039091169183156108fc02918491818181858888f193505050505060066004548154811015156107ec57fe5b6000918252602082206001600290920201810154825403909155600480549091019055610744560053686f776e20696e202520666f726d2e204665652069732068616c766564283530252920666f7220616d6f756e747320657175616c206f722067726561746572207468616e203530206574686572732e2028466565206d6179206368616e67652c206275742069732063617070656420746f2061206d6178696d756d206f662031302529416c6c2062616c616e63652076616c75657320617265206d6561737572656420696e204574686572732c206e6f746520746861742064756520746f206e6f20646563696d616c20706c6163696e672c2074686573652076616c7565732073686f7720757020617320696e746567657273206f6e6c792c2077697468696e2074686520636f6e747261637420697473656c6620796f752077696c6c206765742074686520657861637420646563696d616c2076616c756520796f752061726520737570706f73656420746f54686973206d756c7469706c696572206170706c69657320746f20796f7520617320736f6f6e206173207472616e73616374696f6e2069732072656365697665642c206d6179206265206c6f776572656420746f2068617374656e207061796f757473206f7220696e63726561736564206966207061796f75747320617265206661737420656e6f7567682e2044756520746f206e6f20666c6f6174206f7220646563696d616c732c206d756c7469706c696572206973207831303020666f722061206672616374696f6e616c206d756c7469706c69657220652e672e203235302069732061637475616c6c79206120322e3578206d756c7469706c6965722e20436170706564206174203378206d617820616e6420312e3278206d696e2ea165627a7a7230582065bc9ed1f44a06d0e3658fc6b86e512f6d018b6962dfda4647131b6a68e2dbaa0029
        storage:
            0x0: 0x000000000000000000000000000000000000000000000005e1bd6f2471e20000 # balance
            0x1: 0x0000000000000000000000000000000000000000000000005a34a38fc00a0000 # collected fees
            0x2: 0x0a # fee Percentage
            0x3: 0x012c # pyramid multiplier
            # 0x4 set to 0
            # 0x5 mistakenly not set by the contract (this is the owner variable)
            0x6: 0x0000000000000000000000000000000000000000000000000000000000000004 # array length
            0xf652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d44: 0x0821ab0d4414980000
            0xf652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d40: 0x0821ab0d4414980000
            0xf652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d41: 0x4b0897b0513fdc7c541b6d9d7e929c4e5364d2db
            0xf652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d43: 0x583031d1113ad414f02576bd6afabfb302140225
            0xf652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d42: 0x01a055690d9db80000
            0xf652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f: 0x14723a09acff6d2a60dcdf7aa4aff308fddc160c
            0xf652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d45: 0x000000000000000000000000dd870fa1b7c4700f2bd7f44238821c26f7392148
            0xf652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d46: 0x000000000000000000000000000000000000000000000000d02ab486cedc0000

victim: 0x692a70d2e424a56d2c6c27aa97d1a86395877b3a
";

pub const PARITY_REDUCED: &str = "
state:
    0xaad62f08b3b9f0ecc7251befbeff80c9bb488fe9:
        balance: 0x10000
        code: 6080604052600436106100615763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416634123cb6b8114610066578063746c91711461008d578063c4076876146100a2578063c57c5f60146100d5575b600080fd5b34801561007257600080fd5b5061007b61012c565b60408051918252519081900360200190f35b34801561009957600080fd5b5061007b610132565b3480156100ae57600080fd5b506100d373ffffffffffffffffffffffffffffffffffffffff60043516602435610138565b005b3480156100e157600080fd5b50604080516020600480358082013583810280860185019096528085526100d39536959394602494938501929182918501908490808284375094975050933594506101ae9350505050565b60005481565b60015481565b60003660405180838380828437820191505092505050604051809103902061015f81610273565b156101a95760405173ffffffffffffffffffffffffffffffffffffffff84169083156108fc029084906000818181858888f193505050501580156101a7573d6000803e3d6000fd5b505b505050565b815160019081016000908155336003819055815261010260205260408120919091555b825181101561026c5782818151811015156101e857fe5b6020908102909101015173ffffffffffffffffffffffffffffffffffffffff166002828101610100811061021857fe5b0181905550806002016101026000858481518110151561023457fe5b602090810290910181015173ffffffffffffffffffffffffffffffffffffffff168252810191909152604001600020556001016101d1565b5060015550565b3360009081526101026020526040812054818082151561029257610379565b600085815261010360205260409020805490925015156102ee576001805483556000838201556101048054916102ca91908301610381565b60028301819055610104805487929081106102e157fe5b6000918252602090912001555b8260020a9050808260010154166000141561037957815460011061036657600085815261010360205260409020600201546101048054909190811061032f57fe5b6000918252602080832090910182905586825261010390526040812081815560018082018390556002909101919091559350610379565b8154600019018255600182018054821790555b505050919050565b8154818355818111156101a9576000838152602090206101a99181019083016103be91905b808211156103ba57600081556001016103a6565b5090565b905600a165627a7a72305820a3550987b20be0fac98c2fe5d76884c82d76129f0889f7c4432ac9c2a00cf9f70029
        nonce: 0x1000000

victim: 0xaad62f08b3b9f0ecc7251befbeff80c9bb488fe9
";
